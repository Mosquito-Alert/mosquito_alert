# Generated by Django 3.2.25 on 2025-03-18 15:54

from datetime import timedelta

from django.db import migrations, models

from django.contrib.contenttypes.models import ContentType


def mark_hidden_reports_not_published_from_identification_task(apps, schema_editor):
    Report = apps.get_model('tigaserver_app', 'Report')
    ExpertReportAnnotation = apps.get_model('tigacrafting', 'ExpertReportAnnotation')

    from tigacrafting.models import ExpertReportAnnotation as ExpertReportAnnotationModel

    Report.objects.filter(
        identification_task__isnull=True,
        hide=False
    ).filter(
        models.Exists(
            ExpertReportAnnotation.objects.filter(
                report=models.OuterRef('pk'),
                validation_complete=True,
                revise=True,
                status=ExpertReportAnnotationModel.STATUS_HIDDEN
            )
        )
    ).update(hide=True)

def populate_report_published_at(apps, schema_editor):
    Report = apps.get_model('tigaserver_app', 'Report')
    Photo = apps.get_model('tigaserver_app', 'Photo')
    UUIDTaggedItem = apps.get_model('tigaserver_app', 'UUIDTaggedItem')
    ExpertReportAnnotation = apps.get_model('tigacrafting', 'ExpertReportAnnotation')
    IdentificationTask = apps.get_model('tigacrafting', 'IdentificationTask')

    from tigaserver_app.models import Report as ReportModel
    from tigacrafting.models import IdentificationTask as IdentificationTaskModel

    ReportContentType = ContentType.objects.get_for_model(Report)

    report_qs = Report.objects.filter(
        hide=False,
        deleted_at__isnull=True,
        location_is_masked=False,
        published_at__isnull=True
    ).exclude(
        models.Exists(
            UUIDTaggedItem.objects.filter(
                object_id=models.OuterRef('pk'),
                content_type__pk=ReportContentType.pk,
                tag__name='345'
            )
        )
    )

    # Bite reports
    report_qs.filter(type=ReportModel.TYPE_BITE).update(
        published_at=models.F('server_upload_time')
    )

    photos_exist = models.Exists(
        Photo.objects.filter(
            report=models.OuterRef('pk')
        )
    )

    # Breeding site reports
    sites_qs = report_qs.filter(type=ReportModel.TYPE_SITE)

    # Adult site reports
    adult_report_qs = report_qs.filter(type=ReportModel.TYPE_ADULT)

    # Without photos -> direct publication
    sites_qs.exclude(photos_exist).update(
        published_at=models.F('server_upload_time')
    )
    adult_report_qs.exclude(photos_exist).update(
        published_at=models.F('server_upload_time')
    )

    # With photos
    # Breeding sites: 2 days margin publication
    sites_qs.filter(photos_exist).update(
        published_at=models.F('server_upload_time') + timedelta(days=2)
    )

    # Adult reports (with done identification_task)
    adult_report_qs = adult_report_qs.filter(
        identification_task__is_safe=True,
        identification_task__status=IdentificationTaskModel.Status.DONE
    )
    # First: the reviewed by a supervisor
    adult_report_qs.filter(
        identification_task__reviewed_at__isnull=False
    ).update(
        published_at=models.Subquery(
            IdentificationTask.objects.filter(
                report=models.OuterRef('pk')
            ).values('reviewed_at')[:1]
        )
    )

    # Second: the directly marked as DONE becuase of executive annotation
    adult_report_qs.filter(
        identification_task__reviewed_at__isnull=True
    ).update(
        published_at=models.Subquery(
            ExpertReportAnnotation.objects.filter(
                identification_task=models.OuterRef('pk'),
                user__groups__name='expert',
                validation_complete=True,
                validation_complete_executive=True
            ).exclude(
                user__groups__name='superexpert'
            ).order_by('-last_modified').values('last_modified')[:1]
        )
    )

class Migration(migrations.Migration):

    dependencies = [
        ('tigaserver_app', '0077_indexing_for_refactor_queues'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalreport',
            name='published_at',
            field=models.DateTimeField(blank=True, editable=False, db_index=True, help_text='Datetime when the report was published.', null=True),
        ),
        migrations.AddField(
            model_name='report',
            name='published_at',
            field=models.DateTimeField(blank=True, editable=False, db_index=True, help_text='Datetime when the report was published.', null=True),
        ),
        migrations.AddConstraint(
            model_name='report',
            constraint=models.CheckConstraint(check=models.Q(('published_at__isnull', True), models.Q(('hide', False), ('deleted_at__isnull', True), ('location_is_masked', False)), _connector='OR'), name='is_browsable_when_published'),
        ),
        migrations.RunPython(mark_hidden_reports_not_published_from_identification_task, migrations.RunPython.noop),
        migrations.RunPython(populate_report_published_at, migrations.RunPython.noop),
        migrations.RemoveField(
            model_name='report',
            name='cached_visible',
        ),
    ]
