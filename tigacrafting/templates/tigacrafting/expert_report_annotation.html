{% load staticfiles %}
{% load leaflet_tags %}
{% load i18n %}
{% load floppyforms %}
{% load inbox %}


<!DOCTYPE html>
<html lang={% block language %}"en"{% endblock %}>
<head>

    {% block encoding %}
        <meta charset="utf-8">{% endblock %}
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta name="description" content="MosquitoAlert">
    <meta name="author" content="Movement Ecology Laboratory">

    <title>{% block page_title %}Tigacrafting{% endblock %}</title>

    {% block bootstrap_css %}
        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href={% static "tigacrafting/bootstrap-3.2.0-dist/css/bootstrap.min.css" %}>
        <link rel="stylesheet" href={% static "tigacrafting/bootstrap-select/css/bootstrap-select.min.css" %}>
    {% endblock %}

    <!--script src={% static "tigacrafting/jquery/1.11.1/jquery.min.js" %}></script-->
    <script src={% static "tigacrafting/jquery/1.8.3/jquery-1.8.3.min.js" %}></script>
    <!--script src={% static "tigacrafting/jquery-ui/jquery-ui.min.js" %}></script-->
    <script src={% static "tigacrafting/jquery-ui-1.8.24/jquery-ui.min.js" %}></script>
    <script src={% static "tigacrafting/tag-it/tag-it.min.js" %}></script>
    <!--link rel="stylesheet" href={% static "tigacrafting/jquery-ui/jquery-ui.css" %}-->
    <link rel="stylesheet" href={% static "tigacrafting/jquery-ui-1.8.24/jquery-ui.css" %}>
    <link rel="stylesheet" href={% static "tigacrafting/tag-it/jquery.tagit.css" %}>
    <link rel="stylesheet" href={% static "tigacrafting/tokenize2/tokenize2.min.css" %}>

    <script type="text/javascript" src={% static "tigacrafting/jquery-qrcode/jquery.qrcode.min.js" %}></script>
    <script src={% static "tigacrafting/tokenize2/tokenize2.min.js" %}></script>
    <style>
        #ex1Slider .slider-selection {
            background: #BABABA;
        }

        .container_value, .container_mix, .container_other, .container_category{
            font-size: 14px;
        }

        .tokenize-dropdown{
            z-index: 9999;
        }

        html body.modal-open div#searchModal.modal.fade.in div.modal-dialog div.modal-content div.modal-body table tbody tr td div.btn-group.bootstrap-select.show-tick.tokenize-report-id{
            display: none;
        }

        html body.modal-open div#searchModal.modal.fade.in div.modal-dialog div.modal-content div.modal-body table tbody tr td div.btn-group.bootstrap-select.show-tick.tokenize-report-uuid{
            display: none;
        }

    </style>

    {% block fa_css %}
        <!-- FA CSS -->
        <link rel="stylesheet" href={% static "tigacrafting/font-awesome-4.2.0/css/font-awesome.min.css" %}>
    {% endblock %}


    {% block fallback_bs_js %}

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    {% endblock %}

    {% leaflet_js %}
    {% leaflet_css %}


    <link rel="stylesheet" href={% static "tigacrafting/tigacrafting_style.css" %}>

    <script type="text/javascript">

        var mosquito_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "tigamap/yellow_icon.png" %}'
            }
        });
        var site_icon_class = L.Icon.Default.extend({
            options: {
                iconUrl: '{% static "tigamap/blue_icon.png" %}'
            }
        });

        var mosquito_icon = new mosquito_icon_class;
        var site_icon = new site_icon_class;

        {% for form in formset %}
            function map_init_basic{{ form.instance.id }}(map, options) {

                L.marker([{{ form.instance.report.lat }}, {{ form.instance.report.lon }}], {icon:
                        {% if form.instance.report.type == 'site' %}site_icon{% else %}
                            mosquito_icon{% endif %}}).bindPopup('<table><tbody><tr><td><strong>Lat:</strong></td><td>{{ form.instance.report.lat }}</td></tr><tr><td><strong>Lon:</strong></td><td>{{ form.instance.report.lon }}</td></tr></tbody></table><br><a style="color:white;" class="btn btn-primary btn-sm" target="_blank" href="{% url 'webmap.show_map_defaults' %}?center_lon={{ form.instance.report.lon }}&center_lat={{ form.instance.report.lat }}&zoom=14&map_type={{ form.instance.report.type }}&year={{ form.instance.report.creation_time.year }}">View on Public Map</a>{% if request.user.is_staff %}<br><br><a style="color:white;" class="btn btn-danger btn-sm" target="_blank" href="{% url 'admin:tigaserver_app_report_change' form.instance.report.version_UUID %}">View Admin</a>{% endif %}').addTo(map);

            }
        {%  endfor %}

    </script>

</head>

<body>

{% block navbar %}
    <!-- NAVBAR
================================================== -->
    <div class="navbar-wrapper">
        <div class="container">
            <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
                <div id="navbar" class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                                data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <div class="navbar-brand">
                            <span style="color:#ff9900; font-size: small">MosquitoAlert Validation <i id="gear" class="fa fa-refresh fa-spin"></i></span>
                        </div>
                    </div>
                    <div class="navbar-collapse collapse">

                        <ul class="nav navbar-nav navbar-left">
                            {% block navbar_left_items %}
                                <li>

                                    <div class="btn-group" id="status_grp" data-toggle="buttons">
                                        <label class="btn btn-primary btn-sm navbar-btn" data-toggle="tooltip"
                                               data-placement="bottom" title="Pending" id="pending_btn">
                                            <input type="radio" name="status" autocomplete="off"><span
                                                class="glyphicon glyphicon-time"
                                                {% if n_pending > 0 %}style="color:#FF8576"{% endif %}></span> <span
                                                class="badge">{{ n_pending }}</span></label>
                                        <label class="btn btn-primary btn-sm navbar-btn" data-toggle="tooltip"
                                               data-placement="bottom" title="Complete" id="complete_btn">
                                            <input type="radio" name="status" autocomplete="off"><span
                                                class="glyphicon glyphicon-check"></span> <span
                                                class="badge">{{ n_complete }}</span>
                                        </label>
                                    </div>
                                </li>
                            {% endblock %}

                            <li>
                                <span data-toggle="modal" data-target="#myModal"><button type="button"
                                                                                         class="btn btn-warning btn-sm navbar-btn"
                                                                                         data-toggle="tooltip"
                                                                                         data-placement="bottom"
                                                                                         title="Filter"
                                                                                         style="margin-left:5px"><span
                                        class="glyphicon glyphicon-filter"
                                        {% if orderby != 'date' or tiger_certainty != 'all' or site_certainty != 'all' or status != 'all' %}style="color:black"{% endif %}></span>
                                </button></span>
                            </li>

                            <li>
                                <span data-toggle="modal" data-target="#searchModal"><button type="button"
                                                                                             class="btn btn-warning btn-sm navbar-btn"
                                                                                             data-toggle="tooltip"
                                                                                             data-placement="bottom"
                                                                                             title="Search"
                                                                                             style="margin-left:5px">
                                    <span class="glyphicon glyphicon-search"
                                          {% if version_uuid != 'na' and version_uuid != '' or linked_id != 'na' and linked_id != '' or tags_filter != 'na' and tags_filter != '' %}style="color:black"{% endif %}></span>
                                </button></span>
                            </li>

                            {% block grab_reports_button %}
                                <li>
                                    <button style="margin-left: 5px;" id="grab_reports_button" role="button"
                                            class="btn btn-danger btn-sm navbar-btn" data-toggle="tooltip"
                                            data-placement="bottom" title="Grab new reports"><span
                                            class="glyphicon glyphicon-download"></span></button>
                                </li>
                            {% endblock %}


                            <li>
                                <button id="save_button" type="submit" class="btn btn-success btn-sm navbar-btn"
                                        style="margin-left:5px" data-toggle="tooltip" data-placement="bottom"
                                        title="Save"><span
                                        class="glyphicon glyphicon-floppy-disk"></span>
                                </button>
                            </li>
                        </ul>


                        <ul class="nav navbar-nav navbar-right">
                                <li>
                                    <select class="selectpicker show-tick form-control" id="note_language_select" class="selectpicker show-tick form-control">
                                            <option id="note_language_select_es" value="es">Public note lang. - es</option>
                                            <option id="note_language_select_en" value="en">Public note lang. - en</option>
                                    </select>
                                </li>
                            {% block navbar_right_items %}
                            {% endblock %}
                            {% if tasks_per_page_choices %}
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reports per page<span class="caret"></span></a>
                                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                        {% for n in tasks_per_page_choices %}
                                            <li>
                                                {% if n|add:"0" == tasks_per_page|add:"0" %}
                                                    <a href="{% url 'expert_report_annotation' %}?tasks_per_page={{ n }}&orderby={{ orderby }}&tiger_certainty={{ tiger_certainty }}&site_certainty={{ site_certainty }}&status={{ status }}&pending={{ pending }}&final_status={{ final_status }}&checked={{ checked }}"><span class="glyphicon glyphicon-check"></span>{{ n }}</a>
                                                {% else %}
                                                    <a href="{% url 'expert_report_annotation' %}?tasks_per_page={{ n }}&orderby={{ orderby }}&tiger_certainty={{ tiger_certainty }}&site_certainty={{ site_certainty }}&status={{ status }}&pending={{ pending }}&final_status={{ final_status }}&checked={{ checked }}">{{ n }}</a>
                                                    <!--<a href="{% url 'expert_report_annotation' %}?tasks_per_page={{ n }}&orderby={{ orderby }}&tiger_certainty={{ tiger_certainty }}&site_certainty={{ site_certainty }}&status={{ status }}&pending={{ pending }}&final_status={{ final_status }}&checked={{ checked }}">{{ n }}</a>-->
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endif %}
                            {% inbox_count as my_var %}
                            <li>
                                <a href="{% url 'messages_inbox' %}">Messages <span class="badge {%if my_var > 0%}pending{% else %}clear{% endif %}">{{ my_var }}</span></a>
                            </li>


                            <li><p class="navbar-text">{{ request.user.username }}</p></li>
                            <li><a href="{% url "auth_logout" %}">logout</a>
                            </li>
                        </ul>


                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block main_body %}


    <div class="container">

    <div class="starter-template">

        {% block title %}
            <h1>Expert Report Validation</h1>
            <h2>{% if version_uuid != 'na' and version_uuid != '' or linked_id != 'na' and linked_id != '' or tags_filter != 'na' and tags_filter != '' %}Search
                Result{% else %}{% if pending == 'pending' %}Pending Reports{% elif pending == 'complete' %}Completed
                    Reports{% endif %}{% endif %}</h2>

            {% if version_uuid != 'na' and version_uuid != '' or linked_id != 'na' and linked_id != '' or tags_filter != 'na' and tags_filter != '' %}{% else %}
                <strong>Ordered by:</strong> {{ orderby }}<br>
                <strong>Filters:</strong> Species classification - {{ tiger_certainty_label }}, Status - {{ status }}
            {% endif %}
        {% endblock %}
            <br><strong>Reports Matching Current Filter/Search Criteria:</strong> <span class="badge">{{ n_query_records }}</span>


        <div style="text-align: left">

            {% block instructions %}

                {% if pending == 'pending' %}
                    <h4> Instructions <button data-toggle="tooltip" id="details" type="button" class="btn btn-primary">Show</button></h4>
                    <div class="persiana" style="display: none;">
                    <p>
                        You can be assigned a simplified report or a full report. In case of the simplified report, the steps
                        in <span style="color:blue;">blue</span> are ommitted.
                        For each report:
                        <ul>
                        <li>
                            (1) Select a species classification. If you choose any of the current Aedes or Culex,
                            choose also the degree of certainty matching your degree of belief that the picture contains the
                            species. If you choose 'Complex', select also the species combo. If you choose 'Other', please specify the other
                            species that you are sure it is.
                        </li>
                        <li style="color:blue;">
                            (2) add any note you want to see displayed on the public map along with the report. Please be careful not to write
                            any sensitive information here such as names, e-mail addresses, telephone numbers or anything which can be considered
                            personal/sensitive data.
                        </li>
                        <li style="color:blue;">
                            (3) add any internal tags for this report, which can help you locate it later.
                        </li>
                        <li>
                            (4) add any internal notes for yourself or other experts regarding your reasons for each selection. These notes will be
                            used only internally and will be never visible anywhere public.
                        </li>
                        <li>
                            (5) flag the report if you want to bring it to the attention of other experts
                            (because it is an especially interesting report or because you have doubts).
                        </li>
                        <li>
                            (6) indicate if the report should be hidden from public view (this will automatically
                            remove it from the public map). If you select to hide or flag the report, you need to specify why you have chosen to
                            do so. Do this by writing an internal comment.
                        </li>
                        <li style="color:blue;">
                            (7) select which (if any) of the reports photos should be displayed on the public map (only one photo will be displayed).
                            Please be careful not to mark any picture which may contain sensitive data such as faces, addresses or anything which can
                            be considered personal/sensitive data.
                        </li>
                        </ul>
                        You can save your work as you go using the "save" button at the top of the screen.
                        When you are done with a given report, check  the "validation complete" box. You will not be
                        able to modify your responses once you have saved a report marked with "validation complete."
                    </p>
                    </div>

                {% else %}
                    <h4> Instructions </h4>
                    <p>You are currently viewing your completed reports. To validate new reports, click the blue
                        'Pending' button at the top of the screen.</p>
                {% endif %}

            {% endblock %}
        </div>
    </div>

    {% if objects.has_next or objects.has_previous %}
        <div class="row">
            <div class="col-md-12">
                <div class="pagination">
                    <span class="step-links">
                        {% if objects.has_previous %}
                        <button class="btn btn-default btn-sm active previous_page_button" type="button">Previous</button>
                        {% endif %}
                        <span class="current">
                        Page {{ objects.number }} of {{ objects.paginator.num_pages }}
                        </span>
                        {% if objects.has_next %}
                        <button class="btn btn-default btn-sm active next_page_button" type="button">Next</button>
                        {% endif %}
                        <br>
                        <form role="form" class="form-inline">
                            <div class="form-group">
                                <input id="page_input_top" type="number" min="1" max="{{ objects.paginator.num_pages }}" class="form-control input-sm" placeholder="Go to page" style="width:100px;">
                                <button id="page_button_top" class="btn btn-default btn-sm active" type="button">Go</button>
                            </div>
                        </form>
                    </span>
                </div>
            </div>
        </div>
    {% endif %}

    {% if objects %}

        {% if pending == 'pending' or checked == 'unchecked' or edit_mode == 'edit' %}
            <form id="formset_forms" class="form-vertical" method="post">{% csrf_token %}
        {% endif %}

    {{ formset.management_form }}

    {% for form in formset %}
        <div class="row row_for_{{ form.instance.report.version_UUID }}">
            <div class="col-md-10">
                <h4>
                    <strong>
                        {{ form.instance.report.type|capfirst }}
                    Report {{ form.instance.report.version_UUID }}
                    </strong>
                    {{ form.instance.report.creation_time|date:"d/m/y H:i" }} UTC
                    - {{ form.instance.report.country_label }} - {{ form.instance.report.language }}
                </h4>
                <h5>
                    <strong>Report code - {{ form.instance.report.report_id }}</strong>
                </h5>
            </div>
            <div class="col-md-1">
                <h4>
                    <a href="{% url 'single_report_view' form.instance.report.version_UUID %}" target="_blank"><span class="glyphicon glyphicon-link" aria-hidden="true" title="View validation status"></span></a>
                </h4>
            </div>
            <div class="col-md-1">
                <h4>
                    {% if form.instance.report.get_superexpert_completed_recipients %}
                        {% if request.user.userstat.is_superexpert %}
                            <a href="{% url 'compose_w_data' %}?recipient={{form.instance.report.get_expert_recipients}}&body=http://{{ request.META.HTTP_HOST }}{{form.instance.report.get_single_report_view_link}}&subject=Report {{form.instance.report.version_UUID}}" target="_blank"><span class="glyphicon glyphicon-envelope" aria-hidden="true" title="Send email to experts about this report..."></span></a>
                        {% else %}
                            <a href="{% url 'compose_w_data' %}?recipient={{form.instance.report.get_superexpert_completed_recipients}}&body=http://{{ request.META.HTTP_HOST }}{{form.instance.report.get_single_report_view_link}}&subject=Report {{form.instance.report.version_UUID}}" target="_blank"><span class="glyphicon glyphicon-envelope" aria-hidden="true" title="Send email to superexperts about this report..."></span></a>
                        {% endif %}
                    {% else %}
                        {% if request.user.userstat.is_superexpert %}
                            <a href="{% url 'compose_w_data' %}?recipient={{form.instance.report.get_expert_recipients}}&body=http://{{ request.META.HTTP_HOST }}{{form.instance.report.get_single_report_view_link}}&subject=Report {{form.instance.report.version_UUID}}" target="_blank"><span class="glyphicon glyphicon-envelope" aria-hidden="true" title="Send email to experts about this report..."></span></a>
                        {% else %}
                            <a href="{% url 'compose_w_data' %}?recipient=super_reritja&body=http://{{ request.META.HTTP_HOST }}{{form.instance.report.get_single_report_view_link}}&subject=Report {{form.instance.report.version_UUID}}" target="_blank"><span class="glyphicon glyphicon-envelope" aria-hidden="true" title="Send email to superexperts about this report..."></span></a>
                        {% endif %}
                    {% endif %}
                </h4>
            </div>
            {% if request.user.userstat.is_superexpert %}
            <!-- Keeping this for future uses, disabled right now -->
            <!--<div class="col-md-1">
                <h4>
                    <a href="http://{{ request.META.HTTP_HOST }}{% url 'notifications' %}?user_uuid={{ form.instance.report.user_id }}" target="_blank"><span class="glyphicon glyphicon-envelope" style="color:red;" aria-hidden="true" title="Send notification to owner of the report..."></span></a>
                </h4>
            </div>-->
            {% endif %}
        </div>
        {% block report_title_status_row %}
            <div class="row">
                <div class="col-md-6">
                    {% if form.instance.simplified_annotation == True %}
                    <strong>This is a simplified report - </strong>
                    {% else %}<strong>This is a full report - </strong>
                    {% endif %}
                    <strong>Who has this report? </strong>{% for an in form.instance.report.get_annotations %}<span class="label label-margin{% if an.validation_complete %} label-success {% else %} label-warning {% endif %}" data-placement="bottom">{% if an.user.username == request.user.username %}{{ an.user.username }} {% else %}{% if an.user.userstat.is_superexpert %}superexpert {% else %}expert {% endif %}{% endif %}<span class="glyphicon {% if an.validation_complete %} glyphicon-check {% else %} glyphicon-time {% endif %}"></span></span>{% endfor %}
                </div>
                <div class="col-md-6">
                    <strong>Tags </strong> {{ form.instance.report.get_tags_bootstrap | safe }}
                </div>
            </div>
        {% endblock %}

        <div class="row">
            <div class="col-md-4" id="{{ form.instance.report.version_UUID }}">
                <br>

                {% block view_others_annotations %}
                {% endblock %}



                {% if pending == 'pending' or checked == 'unchecked' or edit_mode == 'edit' %}
                    <!--
                    <div class="form-group">
                        <div>
                            <strong>Aedes certainty:</strong><br>
                            <select id="aedes_certainty_value_{{ form.instance.id }}">
                                <option value="">--------------</option>
                                <option value="-3">Unclassified</option>
                                <option class="red" value="4">Definitely Aedes aegypti</option>
                                <option class="red" value="3">Probably Aedes aegypti</option>
                                <option value="2">Definitely Aedes albopictus</option>
                                <option value="1">Probably Aedes albopictus</option>
                                <option value="0">Not sure</option>
                                <option value="-1">Probably neither albopictus nor aegypti</option>
                                <option value="-2">Definitely not albopictus or aegypti</option>
                            </select>
                        </div>
                    </div>
                    -->
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-5 container_category">
                            <strong>Species classif.:</strong><br>
                            <select id="category_{{ form.instance.id }}">
                                <option value="">--------------</option>
                                {% for cat in category_list %}
                                <option data-needs-value="{% if cat.specify_certainty_level %}1{% else %}0{% endif %}" value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="col-md-7">
                                <div id="container_value_{{ form.instance.id }}" class="container_value"  style="display:none;">
                                    <strong>Species certainty:</strong><br>
                                    <select id="categoryvalue_{{ form.instance.id }}">
                                        <option value="">--------------</option>
                                        <option value="2">Definitely</option>
                                        <option value="1">Probably</option>
                                    </select>
                                </div>
                                <div id="container_mix_{{ form.instance.id }}" class="container_mix" style="display:none;">
                                    <strong>Species combo:</strong><br>
                                    <select id="complex_{{ form.instance.id }}">
                                        <option value="">--------------</option>
                                        {% for complex in complex_list %}
                                        <option value="{{ complex.id }}">{{ complex.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="container_other_{{ form.instance.id }}" class="container_other" style="display:none;">
                                    <strong>Other species:</strong><br>
                                    <select id="other_{{ form.instance.id }}">
                                        <option value="">Not in the list</option>
                                        <optgroup label="Other insects">
                                        {% for species in other_species_insects %}
                                        <option value="{{ species.id }}">{{ species.name }}</option>
                                        {% endfor %}
                                        </optgroup>
                                        <optgroup label="Culicidae">
                                        {% for species in other_species_culicidae %}
                                        <option value="{{ species.id }}">{{ species.name }}</option>
                                        {% endfor %}
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if form.instance.simplified_annotation == False %}
                    <div class="form-group">
                        <label>Public Note (webmap):</label>
                        <div>
                            <button type="button" id="btn_gp_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Nice picture"><span class="glyphicon glyphicon-star-empty"></span></button>
                            <button type="button" id="btn_yes_thorax_pattern_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Yes thorax pattern"><span class="glyphicon glyphicon-thumbs-up"></span></button>
                            <button type="button" id="btn_no_thorax_pattern_{{ form.instance.id }}" class="btn btn-success btn-sm" title="No thorax pattern"><span class="glyphicon glyphicon-thumbs-down"></span></button>
                            <button type="button" id="btn_not_sure_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Not sure photo"><span class="glyphicon glyphicon-camera"></span></button>
                            <button type="button" id="btn_other_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Other species"><span class="glyphicon glyphicon-remove"></span></button>
                            <button type="button" id="btn_other_insect_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Other insect"><span class="glyphicon glyphicon-arrow-right"></span></button>
                            <button type="button" id="btn_conflict_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Conflict"><span class="glyphicon glyphicon-resize-small"></span></button>
                        </div>
                        <div class="controls field-public_note" data-placement="top" title="" data-toggle="tooltip" data-original-title="Notes to display on public map">
                            <textarea id="public_note_{{ form.instance.id }}" cols="40" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="form-group" {% if request.user.userstat.is_expert %}style="display:none;"{% endif %}>
                        <label>Private Message to User (app):</label>
                        <div>
                            <button type="button" id="btn_pm_discovery_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Discovery"><span class="glyphicon glyphicon-map-marker"></span></button>
                            <button type="button" id="btn_pm_contact_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Contact"><span class="glyphicon glyphicon-envelope"></span></button>
                        </div>
                        <div class="controls field-message_to_user" data-placement="top" title="" data-toggle="tooltip" data-original-title="Message that user will receive when viewing report on phone">
                            <textarea id="message_to_user_{{ form.instance.id }}" cols="40" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Internal Tags:</label>
                        <div>
                            <ul id="tags_{{ form.instance.id }}">
                            </ul>
                        </div>
                    </div>
                    {% endif %}



                    {% form form using "floppyforms/layouts/bootstrap.html" %}

                    {% if checked == 'unchecked' or edit_mode == 'edit' %}

                        <div class="btn-group" id="status_grp" data-toggle="buttons">
                            <label class="btn btn-default btn-lg" data-toggle="tooltip" data-placement="bottom"
                                   title="Confirm expert annotations without changes"
                                   id="confirm_btn_{{ form.instance.id }}">
                                <input type="radio" name="confirm_revise_group_{{ form.instance.id }}"
                                       autocomplete="off">Confirm <span
                                    class="glyphicon glyphicon-thumbs-up"></span></label>
                            <label class="btn btn-default btn-lg" data-toggle="tooltip" data-placement="bottom"
                                   title="Replace expert annotation with your own"
                                   id="revise_btn_{{ form.instance.id }}">
                                <input type="radio" name="confirm_revise_group_{{ form.instance.id }}"
                                       autocomplete="off">Revise <span
                                    class="glyphicon glyphicon-thumbs-down"></span>
                            </label>
                        </div>

                    {% endif %}


                {% else %}
                    <h4><strong>My Responses</strong></h4>

                    {% if request.user.userstat.is_superexpert and checked == 'confirmed' %}

                        <div class="well">Confirmed <span class="glyphicon glyphicon-thumbs-up"></span></div>

                        {% else %}

                    {% if form.instance.report.type == 'adult' %}
                        <strong>Expert classification:</strong><br>
                        <div style="border:1px solid #333333;padding:2px;">
                            <!-- $EURO_SWITCH$ -->
                            {{ form.instance.report.get_final_combined_expert_category_euro }}
                        </div>
                        <strong>My classification:</strong><br>
                        <div style="border:1px solid #333333;padding:2px;">
                            <!-- $EURO_SWITCH$ -->
                            {{ form.instance.get_category_euro }}
                        </div>
                        <strong>Internal Certainty Comments:</strong><br>
                        <div style="overflow: auto;height: 150px;border:1px solid #333333;padding:2px;">
                            {{ form.instance.tiger_certainty_notes }}</div><br>
                    {% else %}
                        <strong>Site Certainty:</strong><br>
                        <div style="border:1px solid #333333;padding:2px;">
                            {% if form.instance.get_site_certainty_category_display %}
                                {{ form.instance.get_site_certainty_category_display }}{% else %}---{% endif %}</div>
                        <br>
                        <strong>Internal Site Certainty Notes:</strong><br>
                        <div style="overflow: auto;height: 150px;border:1px solid #333333;padding:2px;">
                            {{ form.instance.site_certainty_notes }}</div><br>
                    {% endif %}

                    <strong>Public Note (webmap):</strong><br>
                    <div style="overflow: auto;height: 150px;border:1px solid #333333;padding:2px;">
                        {{ form.instance.edited_user_notes }}</div><br>
                    <strong>Private Message To User (app):</strong><br>
                    <div style="overflow: auto;height: 150px;border:1px solid #333333;padding:2px;">
                        {{ form.instance.message_for_user }}</div><br>
                    <strong>Status:</strong><br>
                    <div style="border:1px solid #333333;padding:2px;">
                        {% if form.instance.get_status_display %}{{ form.instance.get_status_display }}{% else %}
                            ---{% endif %}</div><br>
                    <strong>Linked ID:</strong><br>
                    <div style="border:1px solid #333333;padding:2px;">
                        {% if form.instance.linked_id %}{{ form.instance.linked_id }}{% else %}---{% endif %}</div>

                {% endif %}

                    {% if request.user.userstat.is_superexpert %}
                        <br>
                        <a class="btn btn-danger"
                           href="{% url 'expert_report_annotation' %}?version_uuid={{ form.instance.report.version_UUID }}&edit_mode=edit">Edit
                            My Responses <span class="glyphicon glyphicon-edit"></span></a>
                    {% endif %}

{% endif %}
            </div>

            <div class="col-md-4">
                <br>
                <strong>Photos</strong>
                {% if pending == 'pending' or checked == 'unchecked' or edit_mode == 'edit' %}
                    <button id="clear_button_{{ form.instance.id }}" type="button" class="btn btn-default btn-sm">
                        Reset
                    </button><br>

                    <div style="overflow: auto;">
                        {% if request.user.userstat.is_superexpert %}
                            {{ form.instance.report.photo_html_for_report_validation_superexpert | safe }}
                        {% else %}
                            {{ form.instance.report.photo_html_for_report_validation | safe }}
                        {% endif %}
                            <!--<a class="btn btn-default infoPhoto" value="{{ form.instance.report.version_UUID }}">Info. Photo</a>>-->

                    </div>

                    <!--<a class="btn btn-default infoPhoto" value="{{ form.instance.report.version_UUID }}">Info. Photo</a>-->

                {% else %}

                    <div style="overflow: auto;">

                        {{ form.instance.report.get_photo_html_for_report_validation_completed | safe }}

                    </div>

                {% endif %}
            </div>

            <div id="infoPhotoDialog" title="Photo's Metadata" style="height: 350px;">
                <span class="infoPopupTop">
                    {% if photoCoord %}
                        <ul>
                            <li>{{ photoCoord.lat }}</li>
                            <li>{{ photoCoord.lan }}</li>
                        </ul>
                    {% endif %}
                </span>
                <span class="infoPopup">
                    <ul>
                        {% for pD in photoData %}
                            <li>{{ pD.ColorSpace }}</li>
                        {% endfor %}
                    </ul>
                </span>
                <span class="infoPopupGPS"></span>
            </div>
            <div id="noDataAvailable" title="Photo's Metadata">
                <span class="infoNoData">

                </span>
            </div>

            <div class="col-md-4">
                <br>
                <strong>Location</strong>

                <div id="map{{ form.instance.id }}" class="report_annotation_map-container">
                    <div style="z-index:100; position:absolute; top:0; right:0;" id="qrcode{{ form.instance.id }}"></div>
                </div>


                <br>
                <!--
                <strong>User Responses</strong><br>

                <div style="overflow: auto;height: 120px;border:1px solid #333333;padding:2px;">
                    {{ form.instance.report.response_html  | safe }}
                </div>
                <br>
                -->
                <strong>User Notes</strong><br>
                {% if form.instance.simplified_annotation == False %}
                <button type="button" id="btn_copynote_{{ form.instance.id }}" class="btn btn-success btn-sm" title="Copy user note to public note"><span class="glyphicon glyphicon-file" aria-hidden="true"></span></button>
                {% endif %}
                <div id="user_note_{{ form.instance.id }}" style="overflow: auto;height: 100px;border:1px solid #333333;padding:2px;">
                    {{ form.instance.report.note }}
                </div>


            </div>

        </div>

        <br>
        <div class="border-row">

            <br>

        </div>

        <script>

            var best_photo_id = "{{ form.instance.best_photo.id }}";
            $("#" + best_photo_id).css({"border-color": "green", "border-width": "3px", "border-style": "solid"});

            {% if form.instance.report.type == 'adult' %}
                $(".row_for_{{ form.instance.report.version_UUID }}").css({"background-color": "#F2BB66"});
            {% else %}
                $(".row_for_{{ form.instance.report.version_UUID }}").css({"background-color": "#736AFF"});
            {% endif %}


            {% if pending == 'pending' or checked == 'unchecked' or edit_mode == 'edit' %}

                {% if form.instance.report.type == 'adult' %}

                    $("#" + "{{ form.site_certainty_category.auto_id }}").parent().parent().empty().remove();
                    $("#" + "{{ form.site_certainty_notes.auto_id }}").parent().parent().empty().remove();


                {% else %}

                    $("#" + "{{ form.tiger_certainty_category.auto_id }}").parent().parent().empty().remove();
                    $("#" + "{{ form.aegypti_certainty_category.auto_id }}").parent().parent().empty().remove();
                    $("#" + "{{ form.tiger_certainty_notes.auto_id }}").parent().parent().empty().remove();
                {% endif %}


                if ($('#' + '{{ form.best_photo.auto_id }}').val() !== undefined) {
                    $('#' + $('#' + '{{ form.best_photo.auto_id }}').val()).attr('checked', true);
                }

                $('input:radio[name=photo_to_display_report_' + '{{ form.instance.report.version_UUID }}' + ']').change(function () {
                    $('#' + '{{ form.best_photo.auto_id }}').val(this.value);
                });


                $("#clear_button_{{ form.instance.id }}").click(function () {
                    $('#' + '{{ form.best_photo.auto_id }}').val(null);
                    $('input:radio[name=photo_to_display_report_' + '{{ form.instance.report.version_UUID }}' + ']').attr('checked', false);

                });



            {% endif %}

            {% if checked == 'unchecked' or edit_mode == 'edit' %}

                var validation_complete_id_{{ form.instance.id }} = "{{ form.validation_complete.auto_id }}";

                var revise_id_{{ form.instance.id }} = "{{ form.revise.auto_id }}";

                var this_id = "{{ form.instance.id }}";

                //var hidden_form_fields{{ form.instance.id }} = $("#{{ form.edited_user_notes.auto_id }}, #" + "{{ form.message_for_user.auto_id }}, #" + "{{ form.linked_id.auto_id }}, #" + "{{ form.status.auto_id }}, #" + "{{ form.site_certainty_notes.auto_id }}, #" + "{{ form.site_certainty_category.auto_id }}, #" + "{{ form.tiger_certainty_notes.auto_id }}, #" + "{{ form.tiger_certainty_category.auto_id }}, #" + "{{ form.aegypti_certainty_category.auto_id }}, #" + validation_complete_id_{{ form.instance.id }});
                //var hidden_form_fields{{ form.instance.id }} = $("#{{ form.edited_user_notes.auto_id }}, #" + "{{ form.message_for_user.auto_id }}, #" + "{{ form.linked_id.auto_id }}, #" + "{{ form.status.auto_id }}, #" + "{{ form.site_certainty_notes.auto_id }}, #" + "{{ form.site_certainty_category.auto_id }}, #" + "{{ form.tiger_certainty_notes.auto_id }}, #" + "aedes_certainty_value_{{ form.instance.id }}, #" + "public_note_{{ form.instance.id }}, #" + validation_complete_id_{{ form.instance.id }});
                //var hidden_form_fields{{ form.instance.id }} = $("#{{ form.edited_user_notes.auto_id }}, #" + "{{ form.message_for_user.auto_id }}, #" + "{{ form.linked_id.auto_id }}, #" + "{{ form.status.auto_id }}, #" + "{{ form.site_certainty_notes.auto_id }}, #" + "{{ form.site_certainty_category.auto_id }}, #" + "{{ form.tiger_certainty_notes.auto_id }}, #" + "aedes_certainty_value_{{ form.instance.id }}, #" + "public_note_{{ form.instance.id }}, #" + "message_to_user_{{ form.instance.id }}, #" + "tags_{{ form.instance.id }}, #" + validation_complete_id_{{ form.instance.id }});
                var hidden_form_fields{{ form.instance.id }} = $("#{{ form.edited_user_notes.auto_id }}, #" + "{{ form.message_for_user.auto_id }}, #" + "{{ form.linked_id.auto_id }}, #" + "{{ form.status.auto_id }}, #" + "{{ form.site_certainty_notes.auto_id }}, #" + "{{ form.site_certainty_category.auto_id }}, #" + "{{ form.tiger_certainty_notes.auto_id }}, #" + "aedes_certainty_value_{{ form.instance.id }}, #" + "category_{{ form.instance.id }}, #" + "public_note_{{ form.instance.id }}, #" + "message_to_user_{{ form.instance.id }}, #" + "tags_{{ form.instance.id }}, #" + validation_complete_id_{{ form.instance.id }});

                var hidden_photo_fields{{ form.instance.id }} = $("#div_for_photo_to_display_report_" + "{{ form.instance.report.version_UUID }}," + "#clear_button_" + "{{ form.instance.id }}");


                var revise_btn = $("#revise_btn_" + this_id).click(function () {
                    hidden_form_fields{{ form.instance.id }}.parent().parent().slideDown('slow');
                    hidden_photo_fields{{ form.instance.id }}.show();
                    $("#" + revise_id_{{ form.instance.id }}).val(true);
                    $("#" + validation_complete_id_{{ form.instance.id }}).prop('checked', false);
                    //Select by default current status in dropdown, photo, public note and note to user
                    copy_revise_form_fields({{ form.instance.id }});
                });

                var confirm_btn = $("#confirm_btn_" + this_id).click(function (e) {
                    if ($(this).hasClass('active')) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                        $(this).removeClass('active');
                        $("#" + validation_complete_id_{{ form.instance.id }}).prop('checked', false);
                    } else {
                        hidden_form_fields{{ form.instance.id }}.parent().parent().slideUp('slow');
                        hidden_photo_fields{{ form.instance.id }}.hide();
                        $("#" + revise_id_{{ form.instance.id }}).val(false);
                        $("#" + validation_complete_id_{{ form.instance.id }}).prop('checked', true);
                        clear_form('{{ form.instance.id }}');
                    }
                });

                {% if form.instance.revise %}
                    hidden_form_fields{{ form.instance.id }}.parent().parent().show();
                    hidden_photo_fields{{ form.instance.id }}.show();
                    revise_btn.addClass('active');
                {% else %}
                    hidden_form_fields{{ form.instance.id }}.parent().parent().hide();
                    hidden_photo_fields{{ form.instance.id }}.hide();
                {% endif %}

                {% if form.instance.validation_complete and not form.instance.revise %}
                    confirm_btn.addClass('active');
                {% endif %}



            {% endif %}
        </script>


    {% endfor %}


    <input id="save_formset" type="text" name="save_formset" style="display: none;" value="T">
    <input id="scroll_position" type="text" name="scroll_position" style="display: none;" value="0">
    <input id="pending_input" type="text" name="pending" style="display: none;" value="{{ pending }}">
    <input id="checked_input" type="text" name="checked" style="display: none;" value="{{ checked }}">
    <input id="loc_input" type="text" name="loc" style="display: none;" value="{{ loc }}">
    <input id="orderby_input" type="text" name="orderby" style="display: none;" value="{{ orderby }}">
    <input id="tiger_certainty_input" type="text" name="tiger_certainty" style="display: none;"
           value="{{ tiger_certainty }}">
    <input id="site_certainty_input" type="text" name="site_certainty" style="display: none;"
           value="{{ site_certainty }}">
    <input id="status_input" type="text" name="status" style="display: none;" value="{{ status }}">
    <input id="final_status_input" type="text" name="final_status" style="display: none;"
           value="{{ final_status }}">
    <input id="version_uuid_input" type="text" name="version_uuid" style="display: none;"
           value="{{ version_uuid }}">
    <input id="linked_id_input" type="text" name="linked_id" style="display: none;" value="{{ linked_id }}">
    <input id="load_new_reports_input" type="text" name="load_new_reports" style="display: none;"
           value="{{ load_new_reports }}">
    <input id="tasks_per_page_input" type="text" name="tasks_per_page" style="display: none;"
           value="{{ tasks_per_page }}">
    <input id="note_language" type="text" name="note_language" style="display: none;"
           value="{{ note_language }}">
    <input id="next_page_input" type="text" name="page" style="display: none;" value="">

    <input id="tags_filter_input" type="text" name="tags_filter" style="display: none;" value="{{ tags_filter }}">
    </form>




        {% if objects.has_next or objects.has_previous %}
        <div class="row">
            <div class="col-md-12">
                <div class="pagination">
                    <span class="step-links">
                        {% if objects.has_previous %}
                        <button class="btn btn-default btn-sm active previous_page_button" type="button">Previous</button>
                        {% endif %}
                        <span class="current">
                        Page {{ objects.number }} of {{ objects.paginator.num_pages }}
                        </span>
                        {% if objects.has_next %}
                        <button class="btn btn-default btn-sm active next_page_button" type="button">Next</button>
                        {% endif %}
                        <br>
                        <form role="form" class="form-inline">
                            <div class="form-group">
                                <input id="page_input_bottom" type="number" min="1" max="{{ objects.paginator.num_pages }}" class="form-control input-sm" placeholder="Go to page" style="width:100px;">
                                <button id="page_button_bottom" class="btn btn-default btn-sm active" type="button">Go</button>
                            </div>
                        </form>
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="row">
            <div class="col-md-12">
                <div class="well">
                    {% block no_records_message %}
                        {% if pending == 'pending' and n_pending == 0 %}
                            <p>You do not yet have any pending reports in your stack. Click "Get more reports" to start
                                validating.</p>
                        {% else %}
                            <p>No reports match your search criteria.</p>

                        {% endif %}
                    {% endblock %}
                </div>
            </div>
        </div>
    {% endif %}


    </div>

    <div class="modal fade" id="save_block_modal" tabindex="-1" role="dialog"
         aria-labelledby="save_block_modal_label"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="save_block_modal_label">Submit validation</h4>
                </div>
                <div id="save_block_modal_body" class="modal-body">
                    <p>
                        The following reports have been marked as validated, but either:</p>
                        <ul>
                        <li>you haven't chosen any value from the 'Species certainty' dropbox.</li>
                        <li>you have chosen 'Unclassified' from the 'Species certainty' dropbox and made the report status 'public'.</li>
                        <li>you have flagged the report without internal comment (unexplained flag)</li>
                        <li>you have hidden the report without internal comment (unexplained hidden)</li>
                        </ul>

                        <p>Please select a valid value in each of them and hit 'save' again.
                    </p>

                    <div id="reports_validated_without_input_list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="save_warning_modal" tabindex="-1" role="dialog"
         aria-labelledby="save_warning_modal_label"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="save_warning_modal_label">Submit validation</h4>
                </div>
                <div id="save_warning_modal_body" class="modal-body">
                    <p>You are about to submit your validations for the reports listed below.
                        {% if pending == 'pending' %}<strong>
                            You will not be able to modify these once you have submitted them.</strong>
                            {% elif checked == 'unchecked' or checked == 'confirmed' or checked == 'revised' %}<strong>Your
                            submission may immediately appear on the public webmap.</strong>{% endif %} Are you sure you
                        wish to proceed?</p>

                    <div id="reports_being_saved_list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" id="save_warning_submit_button" class="btn btn-success">Submit</button>
                </div>
            </div>
        </div>
    </div>



    {% block filter_modal %}
        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Filters</h4>
                    </div>
                    <div class="modal-body">
                        <form role="form" class="form-horizontal">

                            <div class="form-group">
                                <label for="orderby_select" class="col-sm-4 control-label">Order By:</label>

                                <div class="col-sm-8">
                                    <select id="orderby_select" class="selectpicker show-tick form-control">
                                        <option value="date">Report Date</option>
                                        <option value="tiger_score">Species classification (alphabetical)</option>
                                        <!--<option value="site_score">Site Certainty Score</option>-->
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tiger_certainty_select" class="col-sm-4 control-label">Species classif.:</label>

                                <div class="col-sm-8">
                                    <select id="tiger_certainty_select" class="selectpicker show-tick form-control">
                                        <option value="all">All</option>
                                        {% for cat in category_list %}
                                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                                        {% endfor %}
                                        <!--<option value="-2">Definitely not a tiger mosquito</option>
                                        <option value="-1">Probably not a tiger mosquito</option>
                                        <option value="0">Not sure</option>
                                        <option value="1">Probably a tiger mosquito</option>
                                        <option value="2">Definitely a tiger mosquito</option>-->
                                    </select>
                                </div>
                            </div>
                            <!--
                            <div class="form-group">
                                <label for="site_certainty_select" class="col-sm-4 control-label">Site Certainty
                                    Category:</label>

                                <div class="col-sm-8">
                                    <select id="site_certainty_select" class="selectpicker show-tick form-control">
                                        <option value="all">All</option>
                                        <option value="-2">Definitely not a breeding site</option>
                                        <option value="-1">Probably not a breeding site</option>
                                        <option value="0">Not sure</option>
                                        <option value="1">Probably a breeding site</option>
                                        <option value="2">Definitely a breeding site</option>
                                    </select>
                                </div>
                            </div>
                            -->
                            <div class="form-group">
                                <label for="status_select" class="col-sm-4 control-label">Status:</label>

                                <div class="col-sm-8">
                                    <select id="status_select" class="selectpicker show-tick form-control">
                                        <option value="all">All</option>
                                        <option value="public">Public</option>
                                        <option value="flagged">Flagged</option>
                                        <option value="hidden">Hidden</option>
                                    </select>
                                </div>
                            </div>
                            <!--<div class="form-group">
                                <label for="status_select" class="col-sm-4 control-label">Tags:</label>
                                <div class="col-sm-8">
                                    <ul id="tags_filter">
                                    </ul>
                                </div>
                            </div>-->
                        </form>
                    </div>
                    <div class="modal-footer">
                        {% if orderby != 'date' or tiger_certainty != 'all' or site_certainty != 'all' or status != 'all' %}
                            <a class="btn btn-primary" href="{% url 'expert_report_annotation' %}">Clear Filters</a>
                        {% endif %}

                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" id="filters_submit_button" class="btn btn-warning">Apply</button>
                    </div>
                </div>
            </div>
        </div>


    {% endblock %}



    {% block search_modal %}
        <!-- Modal -->
        <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModal"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="searchModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <table>
                            <tr>
                                <td><label for="uuid_autocomplete"><small>Report UUID (write in the text box the first 3 characters of the uuid for a list):</small></label></td>
                                <td>
                                    <select id="uuid_autocomplete" class="tokenize-report-uuid" multiple></select>
                                </td>
                                <td>
                                    <button type="button" id="search_uuid_autocomplete" class="btn btn-default">Search</button>
                                </td>
                            </tr>
                            <tr>
                                <td><label for="id_autocomplete"><small>Report Code (write in the text box the first 2 characters character of the report id for a list):</small></label></td>
                                <td>
                                    <select id="id_autocomplete" class="tokenize-report-id" multiple></select>
                                </td>
                                <td>
                                    <button type="button" id="search_id_autocomplete" class="btn btn-default">Search</button>
                                </td>
                            </tr>
                            <tr>
                                <td><label for="linked_id_select">Linked ID:</label></td>
                                <td>
                                    <select id="linked_id_select" class="selectpicker show-tick form-control" data-live-search="true">
                                        <option value=""></option>
                                        {% for linked_id in my_linked_ids %}
                                            <option value="{{ linked_id.linked_id }}">{{ linked_id.linked_id }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <button type="button" id="search_linked_id_submit_button" class="btn btn-default">Search</button>
                                </td>
                            </tr>
                            <tr>
                                <td><label for="tags_filter" class="col-sm-2 control-label">Tags:</label></td>
                                <td>
                                    <ul class="tagit ui-widget ui-widget-content ui-corner-all" style="max-width: 300px; min-width: 300px;" id="tags_filter">
                                    </ul>
                                </td>
                                <td>
                                    <button type="button" id="search_tag_submit_button" class="btn btn-default">Search</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="modal-footer">
                        {% if version_uuid != 'na' and version_uuid != '' or linked_id != 'na' and linked_id != '' or tags_filter != 'na' and tags_filter != '' %}
                            <a class="btn btn-primary" href="{% url 'expert_report_annotation' %}">Clear Search</a>
                        {% endif %}
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>


    {% endblock %}


{% endblock %}


{% block body_scripts %}


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <script src="{% static 'tigacrafting/bootstrap-3.2.0-dist/js/bootstrap.min.js' %}"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static 'tigacrafting/bootstrap-3.2.0-assets/js/ie10-viewport-bug-workaround.js' %}"></script>

    <script src="{% static 'tigacrafting/bootstrap-select/js/bootstrap-select.min.js' %}"></script>

    <script src="{% static 'tigacrafting/javascript/experts.js' %}"></script>

    <script type="text/javascript">
        (function () {
            function loadmap() {

                {% for form in formset %}

                    var centerLat = {{ form.instance.report.lat }};
                    var centerLng = {{ form.instance.report.lon }};
                    var initialZoom = 6;
                    var djoptions = {"layers": [
                                ["OSM", "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                                    "\u00a9 <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"]
                            ],
                                "minimap": true, "scale": "metric", "center": [centerLat, centerLng], "tilesextent": [],
                                "attributionprefix": null, "zoom": initialZoom, "maxzoom": 18, "minzoom": 0, "extent": [
                                    [-90,
                                        -180],
                                    [90,
                                        180]
                                ], "resetview": true, "srid": null, "fitextent": true},
                            options = {djoptions: djoptions, initfunc: loadmap,
                                globals: false, callback: window.map_init_basic};

                    L.Map.djangoMap('map{{ form.instance.id }}', {djoptions: djoptions, initfunc: loadmap,
                        globals: false, callback: eval("window.map_init_basic{{ form.instance.id }}")});
                {% endfor %}

            }

            var loadevents = ["load"];
            if (loadevents.length === 0) loadmap();
            else if (window.addEventListener) for (var i = 0; i < loadevents.length; i++) window.addEventListener(loadevents[i], loadmap, false);
            else if (window.jQuery) jQuery(window).on(loadevents.join(' '), loadmap);
        })();
    </script>

    <script>

        var index_to_id = {};
        var id_to_index = {};
        var final_status_table = {};

        function clear_form(form_id){
            //Clear UI
            $("#aedes_certainty_value_" + form_id).selectpicker('val','');
            //Clear associated hidden input
            $("#id_form-" + id_to_index[form_id] + "-tiger_certainty_category").val('');

            //Clear UI
            $("#public_note_" + form_id).val('');
            //Clear associated hidden input
            $("#id_form-" + id_to_index[form_id] + "-edited_user_notes").val('');

            $("#message_to_user_" + form_id).val('');

            //Clear UI
            $("#tags_" + form_id).tagit("removeAll");
            //Clear associated hidden input
            $("#id_form-" + id_to_index[form_id] + "-tags").val('');

            $("#id_form-" + id_to_index[form_id] + "-tiger_certainty_notes").val('');
            $("#id_form-" + id_to_index[form_id] + "-status").selectpicker('val','');
            $("#id_form-" + id_to_index[form_id] + "-linked_id").val('');
            $("#id_form-" + id_to_index[form_id] + "-message_for_user").val('');
        }

        function clean_text(strInputCode){
            var retVal = strInputCode.replace(/<\/?[^>]+(>|$)/g, "");
            if(retVal=='None'){
                return "";
            }
            return retVal;
        }

        function copy_revise_form_fields(form_id){
            var data = final_status_table[form_id];
            /*
            if( data.score <= 0){
                $("#aedes_certainty_value_" + form_id).selectpicker('val',data.score);
                if( data.score == -3 || data.score == -4) {
                    setTigerCertainty('', form_id);
                    setAegyptiCertainty('', form_id);
                } else {
                    setTigerCertainty(data.score, form_id);
                    setAegyptiCertainty(data.score, form_id);
                }
            }else{
                if( data.category && data.category.indexOf("albopictus") > -1){
                    if(data.score == 2){
                        $("#aedes_certainty_value_" + form_id).selectpicker('val','2');
                        setTigerCertainty("2",form_id);
                    }else if(data.score == 1){
                        $("#aedes_certainty_value_" + form_id).selectpicker('val','1');
                        setTigerCertainty("1",form_id);
                    }
                }else if( data.category && data.category.indexOf("aegypti") > -1){
                    if(data.score == 2){
                        $("#aedes_certainty_value_" + form_id).selectpicker('val','4');
                        setAegyptiCertainty("2", form_id);
                    }else if(data.score == 1){
                        $("#aedes_certainty_value_" + form_id).selectpicker('val','3');
                        setAegyptiCertainty("1", form_id);
                    }
                }
            }
            */

            inputToCategorySelectionRevise(form_id,data.category_struct);

            $("#id_form-" + id_to_index[form_id] + "-status").selectpicker('val',data.status);

            var user_note_clean_text = clean_text(data.user_note);
            $("#user_note_" + form_id).val(user_note_clean_text);
            $("#id_form-" + id_to_index[form_id] + "-message_for_user").val(user_note_clean_text);

            var public_note_clean_text = clean_text(data.public_note);
            $("#public_note_" + form_id).val(public_note_clean_text);
            $("#id_form-" + id_to_index[form_id] + "-edited_user_notes").val(public_note_clean_text);

            if(data.photo){
                $('#' + data.photo).attr('checked', true);
                $("#id_form-" + id_to_index[form_id] + "-best_photo").val(data.photo);
            }
        }

        function aedesValueToInput(value, input_id){
            if(value == '4'){
                setTigerCertainty("", input_id);
                setAegyptiCertainty("2", input_id);
            }else if(value == '3'){
                setTigerCertainty("", input_id);
                setAegyptiCertainty("1", input_id);
            }else if(value == '2'){
                setTigerCertainty("2", input_id);
                setAegyptiCertainty("", input_id);
            }else if(value == '1'){
                setTigerCertainty("1", input_id);
                setAegyptiCertainty("", input_id);
            }else if(value == '0'){
                setTigerCertainty("0", input_id);
                setAegyptiCertainty("0", input_id);
            }else if(value == '-1'){
                setTigerCertainty("-1", input_id);
                setAegyptiCertainty("-1", input_id);
            }else if(value == '-2'){
                setTigerCertainty("-2", input_id);
                setAegyptiCertainty("-2", input_id);
            }else if(value == '-3'){
                setTigerCertainty("", input_id);
                setAegyptiCertainty("", input_id);
            }
        }

        function inputToPublicNoteValue(input_id){
            var note = getPublicNote(input_id);
            $("#public_note_" + input_id).val(note);
        }

        function inputToUserMessageValue(input_id){
            var message = getUserMessage(input_id);
            $("#message_to_user_" + input_id).val(message);
        }

        function inputToCategorySelectionRevise(input_id,data){
            var category = data.category_id;
            var value = data.value;
            var complex = data.complex_id;
            //var other = $('#id_form-' + id_to_index[input_id] + '-other_species').val();
            var species_categories = [];
            {% for cat in category_list %}
                {% if cat.specify_certainty_level %}
                    species_categories.push('{{ cat.id }}');
                {% endif %}
            {% endfor %}
            if( category == "8" ){ //complex
                $('#container_mix_' + input_id).show();
                $('#container_value_' + input_id).hide();
                $('#container_other_' + input_id).hide();
                $('#complex_' + input_id).val(complex);
                $('#category_' + input_id).selectpicker("val","8");
            }else if ( category == "2" ){ //other species
                $('#container_mix_' + input_id).hide();
                $('#container_value_' + input_id).hide();
                $('#container_other_' + input_id).show();
                $('#category_' + input_id).selectpicker("val","2");
            }else if ( species_categories.indexOf(category) >= 0 ){
                $('#container_value_' + input_id).show();
                $('#container_mix_' + input_id).hide();
                $('#categoryvalue_' + input_id).selectpicker("val",value);
                $('#category_' + input_id).selectpicker("val",category);
            }else{
                $('#container_mix_' + input_id).hide();
                $('#container_value_' + input_id).hide();
            }
            do_translate_classification(input_id);

            var selected_other = $('#other_' + input_id).find(':selected').val();
            $('#id_form-' + id_to_index[input_id] + '-other_species').val(selected_other);

            var selected_complex = $('#complex_' + input_id).find(':selected').val();
            $('#id_form-' + id_to_index[input_id] + '-complex').val(selected_complex);

            var selected_category = $('#category_' + input_id).find(':selected').val();
            $('#id_form-' + id_to_index[input_id] + '-category').val(selected_category);

            var selected_category_value = $('#categoryvalue_' + input_id).find(':selected').val();
            $('#id_form-' + id_to_index[input_id] + '-validation_value').val(selected_category_value);
        }

        function inputToCategorySelection(input_id){
            var category = $('#id_form-' + id_to_index[input_id] + '-category').val();
            var value = $('#id_form-' + id_to_index[input_id] + '-validation_value').val();
            var complex = $('#id_form-' + id_to_index[input_id] + '-complex').val();
            var other = $('#id_form-' + id_to_index[input_id] + '-other_species').val();
            var species_categories = [];
            {% for cat in category_list %}
                {% if cat.specify_certainty_level %}
                    species_categories.push('{{ cat.id }}');
                {% endif %}
            {% endfor %}
            //$('#category_' + input_id).selectpicker("val",category);
            $('#category_' + input_id).val(category);
            if( category == "8" ){ //complex
                $('#container_mix_' + input_id).show();
                $('#container_value_' + input_id).hide();
                $('#container_other_' + input_id).hide();
                $('#complex_' + input_id).val(complex);
            }else if ( category == "2" ){ //other species
                $('#container_mix_' + input_id).hide();
                $('#container_value_' + input_id).hide();
                $('#container_other_' + input_id).show();
                $('#other_' + input_id).val(other);
            }else if ( species_categories.indexOf(category) >= 0 ){
                $('#container_value_' + input_id).show();
                $('#container_mix_' + input_id).hide();
                $('#categoryvalue_' + input_id).val(value);
            }else{
                $('#container_mix_' + input_id).hide();
                $('#container_value_' + input_id).hide();
            }
        }

        function inputToAedesValue(input_id){
            var i = 0;
            var tiger_val = getTigerCertainty(input_id);
            var aegypti_val = getAegyptiCertainty(input_id);

            if ( tiger_val == '' && aegypti_val != '' ){
                //aegypti
                if(aegypti_val == '2'){
                    $("#aedes_certainty_value_" + input_id).val('4');
                }else if(aegypti_val == '1'){
                    $("#aedes_certainty_value_" + input_id).val('3');
                }
            }else if ( tiger_val != '' && aegypti_val == '' ){
                //albopictus
                if(tiger_val == '2'){
                    $("#aedes_certainty_value_" + input_id).val('2');
                }else if(tiger_val == '1'){
                    $("#aedes_certainty_value_" + input_id).val('1');
                }
            }else{
                //any
                $("#aedes_certainty_value_" + input_id).val(tiger_val);
            }

            /*if( tiger_val == '-2' && aegypti_val == '2' ){
                //setDropDown "4"
                $("#aedes_certainty_value_" + input_id).val('4');
            }else if( tiger_val == '-1' && aegypti_val == '1'){
                //setDropDown "3"
                $("#aedes_certainty_value_" + input_id).val('3');
            }else if( tiger_val == '2' && aegypti_val == '-2'){
                //setDropDown "2"
                $("#aedes_certainty_value_" + input_id).val('2');
            }else if( tiger_val == '1' && aegypti_val == '-1' ){
                //setDropDown "1"
                $("#aedes_certainty_value_" + input_id).val('1');
            }else if( tiger_val == '0' && aegypti_val == '0'){
                //setDropDown "0"
                $("#aedes_certainty_value_" + input_id).val('0');
            }else if( tiger_val == '-1' && aegypti_val == '-1'){
                //setDropDown "-1"
                $("#aedes_certainty_value_" + input_id).val('-1');
            }else if( tiger_val == '-2' && aegypti_val == '-2'){
                $("#aedes_certainty_value_" + input_id).val('-2');
            }else{
                $("#aedes_certainty_value_" + input_id).val('');
            }*/
        }

        function updateHiddenTagFieldsFromUI(){
            var total_forms = $("#id_form-TOTAL_FORMS").val();
            for( var i = 0; i < total_forms; i++){
                var ui_value = getTagsFromUI(index_to_id[i]);
                var clean_ui_value = cleanUpHiddenInputTagsArray(ui_value);
                var clean_ui_string = clean_ui_value.join(",");
                setTags(clean_ui_string, index_to_id[i]);
            }
        }

        function setTags(value,input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-tags";
            $('#'+control_name).val(value);
        }

        function setTigerCertainty(value,input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-tiger_certainty_category";
            $('#'+control_name).val(value);
        }

        function setAegyptiCertainty(value,input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-aegypti_certainty_category";
            $('#'+control_name).val(value);
        }

        function getPublicNote(input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-edited_user_notes";
            var retVal = $('#'+control_name).val();
            return retVal;
        }

        function getUserMessage(input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-message_for_user";
            var retVal = $('#'+control_name).val();
            return retVal;
        }

        function getTigerCertainty(input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-tiger_certainty_category";
            var retVal = $('#'+control_name).val();
            return retVal;
        }

        function getTags(input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-tags";
            var retVal = $('#'+control_name).val();
            return retVal;
        }

        function getTagsFromUI(input_id){
            return $("#tags_" + input_id).tagit("assignedTags");
        }

        function getAegyptiCertainty(input_id){
            var control_name = "id_form-" + id_to_index[input_id] + "-aegypti_certainty_category";
            var retVal = $('#'+control_name).val();
            return retVal;
        }

        function cleanUpHiddenInputTagsString(value){
            if (value == "[]") return [];
            var tags = value.split(",");
            var retVal = []
            for(var i = 0; i < tags.length; i++){
                var tag_i = tags[i];
                var res_i = tag_i.replace(/>/g,"").replace("[","").replace("]","");
                retVal.push(res_i.substring(res_i.lastIndexOf(" ")+1));
            }
            return retVal;
        }

        function cleanUpHiddenInputTagsArray(value){
            var tags = value;
            var retVal = []
            for(var i = 0; i < tags.length; i++){
                var tag_i = tags[i];
                var res_i = tag_i.replace(/>/g,"").replace("[","").replace("]","");
                retVal.push(res_i.substring(res_i.lastIndexOf(" ")+1));
            }
            return retVal;
        }

        function inputToTags(input_id){
            var tag_string = getTags(input_id);
            if(!tag_string) tag_string = '';
            var clean_tags = cleanUpHiddenInputTagsString(tag_string);
            for(var i = 0; i < clean_tags.length; i++){
                $("#tags_" + input_id).tagit("createTag", clean_tags[i]);
            }
        }

        function buildFilterTagsUI(){
            var tag_string = $("#tags_filter_input").val();
            var tag_array = [];
            if(tag_string && tag_string != 'na' && tag_string != ''){
                tag_array = tag_string.split(",");
                $("#tags_filter").tagit("removeAll");
                for(var i = 0; i < tag_array.length; i++){
                    $("#tags_filter").tagit("createTag", tag_array[i]);
                }
            }
        }

        function clearString(string){
            var specialChars = "!@#$^&%*()+=-[]\/{}|:<>?,.";
            for (var i = 0; i < specialChars.length; i++) {
                string = string.replace(new RegExp("\\" + specialChars[i], 'gi'), '');
            }
            string = string.toLowerCase();
            //string = string.replace(//gi,"a");
            //string = string.replace(//gi,"e");
            //string = string.replace(//gi,"i");
            //string = string.replace(//gi,"o");
            //string = string.replace(//gi,"u");
            //string = string.replace(//gi,"n");
            return string;
        }

        function getMacroMessageLabelForSpecies(control){
            if(control.val()=='4'){ //albopictus
                return 'albopictus';
            }else if(control.val()=='5'){ //aegypti
                return 'aegypti';
            }else if(control.val()=='6'){ //japonicus
                return 'japonicus';
            }else if(control.val()=='7'){ //koreicus
                return 'koreicus';
            }else if(control.val()=='10'){ //culex
                return 'culex';
            }else{
                return 'all';
            }
            /*
            if(control.val()=='4' || control.val()=='3'){ //aegypti
                return 'aegypti';
            }else if(control.val()=='2' || control.val()=='1'){ //albopictus
                return 'albopictus';
            }else{ //Other
                return 'albopictus';
            }
            */
        }

        $( document ).ready(function() {

            $('#details').click(function(){
                if( $('.persiana').attr("style") == 'display: none;' ){
                    $('.persiana').fadeIn( "slow", function(){});
                    $('#details').html('Hide');
                }else{
                    $('.persiana').fadeOut( "slow", function(){});
                    $('#details').html('Show');
                }
            });

            var total_forms = $("#id_form-TOTAL_FORMS").val();
            index_to_id = {};
            id_to_index = {};
            for( var i = 0; i < total_forms; i++){
                index_to_id[i] = $("#id_form-" + i + "-id").val();
                id_to_index[$("#id_form-" + i + "-id").val()] = i;
            }
            var final_status;
            {% for form in formset %}

                final_status = {
                    score: {{form.instance.report.get_final_combined_expert_score}},
                    //category: '{{form.instance.report.get_final_combined_expert_category}}',
                    category: '{{form.instance.report.get_final_combined_expert_category_euro}}',
                    category_struct: {{form.instance.report.get_final_combined_expert_category_euro_struct_json | safe}},
                    //selector_data : {{ form.instance.report.get_selector_data | safe }},
                    status: {{form.instance.report.get_final_expert_status }},
                    photo: '{{form.instance.report.get_final_photo_html.id}}',
                    public_note: '{{form.instance.report.get_final_public_note | linebreaksbr }}',
                    user_note: '{{form.instance.report.get_final_note_to_user  | linebreaksbr }}'
                };

                $('#note_language_select').val($('#note_language').val());

                final_status_table[{{ form.instance.id }}] = final_status;

                var hidden_photo_fields{{ form.instance.id }} = $("#div_for_photo_to_display_report_" + "{{ form.instance.report.version_UUID }}," + "#clear_button_" + "{{ form.instance.id }}");
                {% if form.instance.simplified_annotation == True %}
                    hidden_photo_fields{{ form.instance.id }}.hide();
                {% endif %}

                inputToCategorySelection('{{ form.instance.id }}');
                inputToAedesValue('{{ form.instance.id }}');
                $("#aedes_certainty_value_{{ form.instance.id }}").change(function(){
                    aedesValueToInput($(this).val(),'{{ form.instance.id }}');
                });
                inputToPublicNoteValue('{{ form.instance.id }}');
                inputToUserMessageValue('{{ form.instance.id }}');

                $("#btn_copynote_{{ form.instance.id }}").click(function() {
                    var txt = $("#user_note_{{ form.instance.id }}").text();
                    if(txt){
                        txt = txt.trim();
                    }
                    $("#public_note_{{ form.instance.id }}").val(txt);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(txt);
                });

                $("#btn_gp_{{ form.instance.id }}").click(function() {
                    //var message = "La foto es espectacular y se ven muchos detalles del cuerpo del mosquito. Gracias por participar. Gran trabajo!";
                    //var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var species_label = 'all';
                    var message = macro_messages[species_label]["nice_picture"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_yes_thorax_pattern_{{ form.instance.id }}").click(function() {
                    //var message = "Muy buena foto! Has conseguido que se pueda identificar perfectamente el mosquito tigre ya que se ve muy bien su tpica lnea blanca en el trax, adems de otras caractersticas. Gracias por participar!";
                    var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var message = macro_messages[species_label]["yes_thorax_pattern"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_no_thorax_pattern_{{ form.instance.id }}").click(function() {
                    //var message = "Con esta foto no podemos asegurar totalmente que sea un mosquito tigre. No se ve bien la tpica lnea blanca en el trax, aunque s que se ven otras caractersticas del mosquito tigre. Aun as, tu observacin sigue siendo muy til. En www.mosquitoalert.com encontrars trucos para atrapar y fotografiar estos insectos. Enva ms fotos!";
                    var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var message = macro_messages[species_label]["no_thorax_pattern"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_not_sure_{{ form.instance.id }}").click(function() {
                    //var message = "Con esta foto no podemos identificar ninguna especie, ya que est borrosa y no se reconocen las caractersticas tpicas del mosquito tigre ni de ninguna otra especie. Aun as, tu observacin sigue siendo til. En www.mosquitoalert.com encontrars trucos para atrapar y fotografiar estos insectos. Enva ms fotos!";
                    //var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var species_label = 'all';
                    var message = macro_messages[species_label]["not_sure_photo"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_other_{{ form.instance.id }}").click(function() {
                    //var message = "Esta foto parece ser de otra especie de mosquito, ya que no se parece ni al mosquito tigre ni al mosquito de la fiebre amarilla. En www.mosquitoalert.com encontrars trucos para reconocer estas especies y atrapar y fotografiar estos insectos. Enva ms fotos!";
                    var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var message = macro_messages[species_label]["other_species"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_other_insect_{{ form.instance.id }}").click(function() {
                    //var message = "Esta foto parece ser de otra especie de mosquito, ya que no se parece ni al mosquito tigre ni al mosquito de la fiebre amarilla. En www.mosquitoalert.com encontrars trucos para reconocer estas especies y atrapar y fotografiar estos insectos. Enva ms fotos!";
                    var species_label = 'all';
                    var message = macro_messages[species_label]["other_insect"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_conflict_{{ form.instance.id }}").click(function() {
                    //var message = "Esta foto parece ser de otra especie de mosquito, ya que no se parece ni al mosquito tigre ni al mosquito de la fiebre amarilla. En www.mosquitoalert.com encontrars trucos para reconocer estas especies y atrapar y fotografiar estos insectos. Enva ms fotos!";
                    var species_label = 'all';
                    var message = macro_messages[species_label]["conflict"][$('#note_language').val()];
                    $("#public_note_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val(message);
                });
                $("#btn_pm_discovery_{{ form.instance.id }}").click(function() {
                    //var message = "Enhorabuena! Tu foto es muy importante, ya que posiblemente has encontrado un mosquito tigre en una zona con poca informacin sobre la distribucin de esta especie. Si encuentras ms, no dudes en enviar ms observaciones y fotos. Gracias por participar!";
                    //var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var species_label = 'all';
                    var message = macro_messages[species_label]["discovery"][$('#note_language').val()];
                    $("#message_to_user_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-message_for_user").val(message);
                });
                $("#btn_pm_contact_{{ form.instance.id }}").click(function() {
                    //var message = "Nos interesa mucho tu observacin, ya que podra ser un descubrimiento excepcional. Si puedes, envanos ms fotos. Para explicarnos ms detalles contacta con nosotros a travs del e-mail info@mosquitoalert.com. Gracias por participar, gran trabajo!";
                    //var species_label = getMacroMessageLabelForSpecies($('#category_{{ form.instance.id }}'));
                    var species_label = 'all';
                    var message = macro_messages[species_label]["contact"][$('#note_language').val()];
                    $("#message_to_user_{{ form.instance.id }}").val(message);
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-message_for_user").val(message);
                });
                $("#public_note_{{ form.instance.id }}").unbind();
                $("#public_note_{{ form.instance.id }}").on('input', function (e) {
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-edited_user_notes").val($(this).val());
                });
                $("#message_to_user_{{ form.instance.id }}").on('input', function (e) {
                    $("#id_form-" + id_to_index[{{ form.instance.id }}] + "-message_for_user").val($(this).val());
                });

                $("#tags_{{ form.instance.id }}").tagit({
                    //beforeTagAdded: function(event, ui) {
                        // do something special
                        //var normalizedTag = ui.tagLabel;
                        //normalizedTag = normalizedTag.toLowerCase();
                        //ui.tagLabel = normalizedTag;
                        //console.log(ui.tagLabel);
                    //},
                    preprocessTag: function(val){
                        if (!val) { return ''; }
                        return clearString(val);
                    },
                    autocomplete: { source: function( request, response ) {
                        $.ajax({
                            url: "/api/tags/",
                            dataType: "json",
                            data: {
                                featureClass: "P",
                                style: "full",
                                maxRows: 12,
                                name: request.term
                            },
                            success: function( data ) {
                                 response( $.map( data, function( item ) {
                                    return {
                                        label: item.name,
                                        value: item.name
                                    }
                                 }));
                            }
                        });
                    },
                    minLength: 2,
                    caseSensitive: false
                    }
                });

                inputToTags('{{ form.instance.id }}');
            {% endfor %}

            $("#tags_filter").tagit({
                autocomplete: { source: function( request, response ) {
                    $.ajax({
                        url: "/api/tags/",
                        dataType: "json",
                        data: {
                            featureClass: "P",
                            style: "full",
                            maxRows: 12,
                            name: request.term
                        },
                        success: function( data ) {
                             response( $.map( data, function( item ) {
                                return {
                                    label: item.name,
                                    value: item.name
                                }
                             }));
                        }
                    });
                },
                minLength: 2,
                preprocessTag: function (val) {
                        if (!val) {
                            return '';
                        }
                        return val.toLowerCase();
                    }
                }
            });

            buildFilterTagsUI();

        });
    </script>

    <script>

        var pending = "{{ pending }}";

        var scroll_position = parseInt({{ scroll_position }});
        if (scroll_position != null && !isNaN(scroll_position) && isFinite(scroll_position)) {
            $(window).scrollTop(scroll_position);
        }

        var grab_reports_button = $("#grab_reports_button");
        var n_pending = {{ n_pending }};
        function toggle_grab_reports_button() {
            if (n_pending < 5) {
                grab_reports_button.prop('disabled', false);
            } else {
                grab_reports_button.prop('disabled', true);
            }
        }


        $('input[id~="value_changed"]').hide();
        $('label[for~="value_changed"]').hide();

        var gear = $("#gear").hide();

        function background_save(qp) {
            /* This is extremely weird and caused some reports to be unvalidated $("[id*='validation_complete']:checked").prop("checked", false);
            and saved when changing the selector from flagged to public reports - changed because clicking these buttons should **NEVER** save
            reports, much less mark them as not validated!*/
            if ($("#formset_forms").length > 0 && ("{{ pending }}" == 'pending' || "{{ checked }}" == 'unchecked')) {
                //$("[id*='validation_complete']:checked").prop("checked", false);
                updateHiddenTagFieldsFromUI();
                $("#formset_forms").submit();
            } else {
                window.location.href = qp;
            }
        }

        function setup_and_launch_save_warning() {
            $(".modal").modal("hide");
            var reports_list_div = $("#reports_being_saved_list").empty();
            reports_list_div.append('<ul></ul>');
            var reports_list = $("#reports_being_saved_list ul");
            $("[id*='validation_complete']:checked").each(function () {
                /*var report_id = $(this).parent().parent().parent().attr('id');
                var n_pictures = $('input[name ="photo_to_display_report_' + report_id + '"]').length;*/
                {% if request.user.userstat.is_superexpert %}
                    if ($(this).siblings("[id*='revise']").val() == "false") {
                        reports_list.append('<li>' + $(this).parent().parent().parent().attr('id') + ' <span style="color:green">Confirming Experts</span></li>');
                    }
                    else if ($(this).siblings("[name*='photo']").val() == ""  ) {
                        reports_list.append('<li>' + $(this).parent().parent().parent().attr('id') + ' <span style="color:red">Revising without photo</span></li>');
                    }
                    else {
                        reports_list.append('<li>' + $(this).parent().parent().parent().attr('id') + ' <span style="color:orange">Revising</span></li>');
                    }
                {% else %}
                    if ($(this).siblings("[name*='photo']").val() == "" && $(this).siblings("[name*='simplified_annotation']").val() == "False") {
                        reports_list.append('<li>' + $(this).parent().parent().parent().attr('id') + ' <span style="color:red">No photo selected</span></li>');
                    } else {
                        reports_list.append('<li>' + $(this).parent().parent().parent().attr('id') + '</li>');
                    }
                {% endif %}

            });
            $("#save_warning_modal").modal('show');
        }

        function setup_and_launch_mustfix_dialog() {
            $(".modal").modal("hide");
            var species_with_value = [];
            {% for cat in category_list %}
                {% if cat.specify_certainty_level %}
                    species_with_value.push('{{ cat.name }}');
                {% endif %}
            {% endfor %}
            var reports_list_div = $("#reports_validated_without_input_list").empty();
            reports_list_div.append('<ul></ul>');
            var reports_list = $("#reports_validated_without_input_list ul");
            $("[id*='validation_complete']:checked").each(function () {

                var form_id = $(this).siblings("[id*='-id']").val();
                var index = id_to_index[form_id];
                var id_string = $(this).siblings("[id*='-id']").attr('id');
                id_string = id_string.replace("id_form-","").replace("-id","");
                //var title = $('button[data-id="aedes_certainty_value_' + form_id + '"]').attr('title');
                var title = $('button[data-id="category_' + form_id + '"]').attr('title');
                var flag_title = $('button[data-id="id_form-' + id_string + '-status"]').attr('title');
                //var flag_title = $('button[data-id="id_form-' + form_id + '-status"]').attr('title');
                var report_id = $(this).parent().parent().parent().attr('id');
                if ( title == '--------------' ){
                    reports_list.append('<li>' + report_id + ' <span style="color:red">Validated without selecting species certainty</span></li>');
                }else{
                    if( title == 'Complex' ){
                        if( $('#complex_' + form_id).val() == "" ){
                            reports_list.append('<li>' + report_id + ' <span style="color:red">Selected complex category and not specified which species combo</span></li>');
                        }
                    }else if ( species_with_value.indexOf(title) >= 0 ){
                        if( $('#categoryvalue_' + form_id).val() == "" ){
                            reports_list.append('<li>' + report_id + ' <span style="color:red">Selected species and not specified species certainty</span></li>');
                        }
                    }
                }
                if ( flag_title == 'flagged' ){
                    if( $("#id_form-" + id_string + "-tiger_certainty_notes").val() == "" ) {
                        reports_list.append('<li>' + report_id + ' <span style="color:red">Flagged without internal species certainty comments</span></li>');
                    }
                }
                if($("#id_form-" + index + "-status").val() == "-1" && $("#id_form-" + index + "-tiger_certainty_notes").val() == ''){
                    reports_list.append('<li>' + report_id + ' <span style="color:red">Hidden without internal species certainty comments</span></li>');
                }
                if($("#id_form-" + index + "-status").val() == "1" && $("#aedes_certainty_value_" + form_id).val() == '-3'){
                    reports_list.append('<li>' + report_id + ' <span style="color:red">Status public and unclassified</span></li>');
                }

            });
            $("#save_block_modal").modal('show');
        }



        function clear_inputs() {
            $("#scroll_position").val(0);
            $("#pending_input").val('na');
            $("#checked_input").val('na');
            $("#loc_input").val('na');
            $("#orderby_input").val('date');
            $("#tiger_certainty_input").val('all');
            $("#site_certainty_input").val('all');
            $("#status_input").val('all');
            $("#final_status_input").val('na');
            $("#version_uuid_input").val('na');
            $("#linked_id_input").val('na');
            $("#tags_filter_input").val('');
            $("#load_new_reports_input").val('F');
        }


        $(document).ready(function () {

            var format_report_label = function(r){
                return r.report_id + ' - version:' + r.version_number + ' - date:' + r.version_time.substring(0,10);
            }

            $('.tokenize-report-id').tokenize2({
                dropdownMaxItems: 15,
                searchMinLength: 2,
                tokensMaxItems: 1,
                zIndexMargin: 9999,
                dataSource: function(term, object){
                    $.ajax('/api/reports_id_filtered/', {
                        data: { report_id: term, start: 0 },
                        dataType: 'json',
                        success: function(data){
                            var $items = [];
                            $.each(data, function(k, v){
                                $items.push({"text": format_report_label(v),"value": v.version_UUID });
                            });
                            object.trigger('tokenize:dropdown:fill', [$items]);
                        }
                    });
                }
            });

            $('.tokenize-report-id').on('tokenize:tokens:add', function(e, value, text){
                $("#version_uuid_input").val(value);
            });

            $('.tokenize-report-id').on('tokenize:tokens:remove', function(e, value){
                $("#version_uuid_input").val('');
            });

            $('.tokenize-report-uuid').tokenize2({
                dropdownMaxItems: 15,
                searchMinLength: 3,
                tokensMaxItems: 1,
                zIndexMargin: 9999,
                dataSource: function(term, object){
                    $.ajax('/api/uuid_list_autocomplete/', {
                        data: { uuid: term, loc: $('#loc_input').val(), start: 0 },
                        dataType: 'json',
                        success: function(data){
                            var $items = [];
                            $.each(data, function(k, v){
                                $items.push({"text": v.report__version_UUID,"value": v.report__version_UUID });
                            });
                            object.trigger('tokenize:dropdown:fill', [$items]);
                        }
                    });
                }
            });

            $('.tokenize-report-uuid').on('tokenize:tokens:add', function(e, value, text){
                $("#version_uuid_input").val(value);
            });

            $('.tokenize-report-uuid').on('tokenize:tokens:remove', function(e, value){
                $("#version_uuid_input").val('');
            });


            $('[data-toggle="tooltip"]').tooltip();

            $('#note_language_select').change(function(){
                //alert($('#note_language_select').val());
                $('#note_language').val($('#note_language_select').val());
            });

            $("select").selectpicker({
                width: 'auto'
            });

            var save_warning_submit_button = $("#save_warning_submit_button").click(function () {
                gear.show();
                $("#scroll_position").val(0);
                toggle_grab_reports_button();
                updateHiddenTagFieldsFromUI();
                $("#formset_forms").submit();

            });


            var save_button = $("#save_button").click(function () {
                //There's at least one of the forms which is marked as validated
                var flagged_without_comment = false;
                var hidden_without_comment = false;
                var validated_without_aedes_input = false;
                var complex_without_class = false;
                var simple_without_value = false;
                var unclassified = false;
                var public_unclassified = false;
                if ($("[id*='validation_complete']").is(":checked")) {
                    //var buttons = $('button[data-id*="aedes_certainty_value"]');
                    var buttons = $('button[data-id*="category_"]');
                    for(var index = 0; index < buttons.size(); index++){
                        var button_title = buttons[index].attributes["title"].value;
                        var status = $('#id_form-' + index + '-status').val();
                        var checked = ($("[id=id_form-" + index + "-validation_complete]:checked").size() == 1);
                        if(button_title == '--------------' && checked){
                            var validated_without_aedes_input = true;
                        }else{
                            if( $('#container_mix_' + index_to_id[index] ).is(':visible') ){
                                if ( $('button[data-id="complex_' + index_to_id[index] + '"]')[0].attributes["title"].value == '--------------' ){
                                    complex_without_class = true;
                                }
                            }
                            if( $('#container_value_' + index_to_id[index] ).is(':visible') ){
                                if ( $('button[data-id="categoryvalue_' + index_to_id[index] + '"]')[0].attributes["title"].value == '--------------' ){
                                    simple_without_value = true;
                                }
                            }
                        }
                        if(button_title == 'Unclassified' && checked){
                            unclassified = true;
                        }
                        //flagged
                        if(status == '0' && checked){
                            if ( $("#id_form-" + index + "-tiger_certainty_notes").val() == "" ){
                                flagged_without_comment = true;
                            }
                        }
                        //hidden
                        if(status == '-1' && checked){
                            if ( $("#id_form-" + index + "-tiger_certainty_notes").val() == "" ){
                                hidden_without_comment = true;
                            }
                        }
                        //public
                        if(status == '1' && checked && button_title == 'Unclassified'){
                            public_unclassified = true;
                        }
                    }
                    {% if request.user.userstat.is_expert %}
                    if(validated_without_aedes_input || complex_without_class || simple_without_value || flagged_without_comment || hidden_without_comment || public_unclassified){
                        //launch ok dialog and not save
                        setup_and_launch_mustfix_dialog();
                    }else{
                        setup_and_launch_save_warning();
                    }
                    {% else %}
                        setup_and_launch_save_warning();
                    {% endif %}
                } else {
                    gear.show();
                    toggle_grab_reports_button();
                    updateHiddenTagFieldsFromUI();
                    $("#formset_forms").submit();
                }
            });


            {% if request.user.userstat.is_expert and pending != 'pending' %}
            save_button.prop('disabled', true);
            {% elif request.user.userstat.is_superexpert and checked != 'unchecked' and edit_mode != 'edit' %}
                save_button.prop('disabled', true);
            {% endif %}

            toggle_grab_reports_button();

            {% for form in formset %}

                jQuery('#qrcode{{ form.instance.id }}').qrcode({
                    width: 64,
                    height: 64,
                    text: "geo:{{ form.instance.report.lat }},{{ form.instance.report.lon }}"
                });

            {% endfor %}
        });

        var scroll_position_input = $("#scroll_position");

        $(window).scroll(function (event) {
            var scroll = $(window).scrollTop();
            scroll_position_input.val(scroll);
        });


    </script>

    {% block filterjs %}
        <script>

            function dict_to_query(obj){
                var str = [];
                for (var p in obj)
                if (obj.hasOwnProperty(p)) {
                    str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
                }
                return "?" + str.join("&");
            }

            function query_to_dict(queryString){
                var dictionary = {};
                if (queryString.indexOf('?') === 0) {
                    queryString = queryString.substr(1);
                }
                var parts = queryString.split('&');
                for(var i = 0; i < parts.length; i++) {
                    var p = parts[i];
                    var keyValuePair = p.split('=');
                    var key = keyValuePair[0];
                    var value = keyValuePair[1];
                    value = decodeURIComponent(value);
                    value = value.replace(/\+/g, ' ');
                    dictionary[key] = value;
                }
                return dictionary;
            }

            function query_selectors() {
                var this_orderby = $("#orderby_select").val();
                var this_tiger_certainty = $("#tiger_certainty_select").val();
                var this_site_certainty = $("#site_certainty_select").val();
                var this_status = $("#status_select").val();
                $("#orderby_input").val(this_orderby);
                $("#tiger_certainty_input").val(this_tiger_certainty);
                $("#site_certainty_input").val(this_site_certainty);
                $("#status_input").val(this_status);
                $("#pending_input").val(pending);
                var qp = '?orderby=' + this_orderby;
                qp += '&tiger_certainty=' + this_tiger_certainty;
                qp += '&site_certainty=' + this_site_certainty;
                qp += '&status=' + this_status;
                qp += '&pending=' + pending;
                return(qp)
            }

            function submit_queries() {
                gear.show();
                var qp = query_selectors();
                background_save(qp);
            }


            function submit_queries_plus(event) {
                gear.show();
                pending = event.data.extr;
                var qp = query_selectors();
                $("#pending_input").val(pending);
                background_save(qp);
            }

            $("#orderby_select").val("{{ orderby }}");
            $("#tiger_certainty_select").val("{{ tiger_certainty }}");
            $("#site_certainty_select").val("{{ site_certainty }}");
            $("#status_select").val("{{ status }}");
            var pending_btn = $("#pending_btn"), complete_btn = $("#complete_btn");
            pending == "complete" ? complete_btn.addClass("active") : (pending == "pending" ? pending_btn.addClass("active") : {});
            pending_btn.on('click', {extr: 'pending'}, submit_queries_plus);
            complete_btn.on('click', { extr: 'complete'}, submit_queries_plus);


        </script>
    {% endblock %}

    <script>


        $("#filters_submit_button").on('click', submit_queries);


        function dict_to_query(obj){
            var str = [];
            for (var p in obj)
            if (obj.hasOwnProperty(p)) {
                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            }
            return "?" + str.join("&");
        }

        function query_to_dict(queryString){
            var dictionary = {};
            if (queryString.indexOf('?') === 0) {
                queryString = queryString.substr(1);
            }
            var parts = queryString.split('&');
            for(var i = 0; i < parts.length; i++) {
                var p = parts[i];
                var keyValuePair = p.split('=');
                var key = keyValuePair[0];
                var value = keyValuePair[1];
                value = decodeURIComponent(value);
                value = value.replace(/\+/g, ' ');
                dictionary[key] = value;
            }
            return dictionary;
        }


        function submit_search_version_uuid() {
            gear.show();
            var this_version_uuid = $( "#uuid_autocomplete option:selected" ).val   ();
            clear_inputs();
            if(this_version_uuid!=null && this_version_uuid!=''){
                $("#version_uuid_input").val(this_version_uuid);
                var qp = '?version_uuid=' + this_version_uuid;
                background_save(qp);
            }
        }

        function submit_search_version_id() {
            gear.show();
            var this_version_uuid = $("#id_autocomplete option:selected").val();
            clear_inputs();
            if(this_version_uuid!=null && this_version_uuid!=''){
                $("#version_uuid_input").val(this_version_uuid);
                var qp = '?version_uuid=' + this_version_uuid;
                background_save(qp);
            }
        }

        function submit_search_linked_id() {
            gear.show();
            clear_inputs();
            var this_linked_id = $("#linked_id_select").val();
            $("#linked_id_input").val(this_linked_id);
            var qp = '?linked_id=' + this_linked_id;
            background_save(qp);
        }

        function submit_search_tag() {
            gear.show();
            clear_inputs();
            var filter_tags = $("#tags_filter").tagit("assignedTags");
            var str_tags = '';
            if(filter_tags){
                str_tags = filter_tags.join(",");
            }
            $("#tags_filter_input").val(str_tags);

            var qp = '?tags_filter=' + encodeURIComponent(str_tags);
            background_save(qp);
        }

        /*$("#search_version_uuid_submit_button").on('click', submit_search_version_uuid);*/

        $("#search_linked_id_submit_button").on('click', submit_search_linked_id);

        $("#search_tag_submit_button").on('click', submit_search_tag);

        $("#search_id_autocomplete").on('click', submit_search_version_id);

        $("#search_uuid_autocomplete").on('click', submit_search_version_uuid);

        grab_reports_button.on('click', function () {
            $("#grab_reports_button").attr("disabled", true);
            gear.show();
            $("#load_new_reports_input").val("T");
            var qp = query_selectors();
            qp += '&load_new_reports=' + "T";
            background_save(qp);
        });

        function go_to_page(top_or_bottom){
            gear.show();
            var qp = query_selectors();
            var selected_page = $("#page_input_" + top_or_bottom ).val();
            qp += '&page=' + selected_page;
            $("#next_page_input").val(selected_page);
            background_save(qp);
        }

        $("#page_button_top").on('click', function () {
            go_to_page('top');
        });

        $("#page_button_bottom").on('click', function () {
            go_to_page('bottom');
        });

        $('#page_input_top').bind("enterKey",function(e){
                go_to_page('top');
        });

        $('#page_input_bottom').bind("enterKey",function(e){
                go_to_page('bottom');
        });

        $('#page_input_top').keyup(function(e){
            if(e.keyCode == 13)
            {
                $(this).trigger("enterKey");
            }
        });

        $('#page_input_bottom').keyup(function(e){
            if(e.keyCode == 13)
            {
                $(this).trigger("enterKey");
            }
        });

        var nb = $(".next_page_button");
        {% if objects.has_next %}
            nb.show().on('click', function () {
                gear.show();
                var next_page = "{{ objects.next_page_number }}";
                var qp = query_selectors();
                qp += '&page=' + next_page;
                var query_params = query_to_dict(qp);
                var items_page = {'tasks_per_page': $('#tasks_per_page_input').val() };
                var merged_params = Object.assign({}, query_params, items_page);
                var merged_params_str = dict_to_query(merged_params);
                $("#next_page_input").val(next_page);
                background_save(merged_params_str);
            });
        {% else %}
            nb.hide();
        {% endif %}

        var pb = $(".previous_page_button");
        {% if objects.has_previous %}
            pb.show().on('click', function () {
                gear.show();
                var previous_page = "{{ objects.previous_page_number }}";
                var qp = query_selectors();
                qp += '&page=' + previous_page;
                var query_params = query_to_dict(qp);
                var items_page = {'tasks_per_page': $('#tasks_per_page_input').val() };
                var merged_params = Object.assign({}, query_params, items_page);
                var merged_params_str = dict_to_query(merged_params);
                $("#next_page_input").val(previous_page);
                background_save(merged_params_str);
            });
        {% else %}
            pb.hide();
        {% endif %}



    </script>

    <script src={% static "tigacrafting/categories_combo.js" %}></script>
    <script src={% static "tigacrafting/macro_messages.js" %}></script>


{% endblock %}

</body>
</html>
